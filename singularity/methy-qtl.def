Bootstrap: library
From: ubuntu:22.04

%files
  scripts/ /opt/scripts/

%environment
  export LC_ALL=C
  export TZ=Etc/UTC

%post
  chmod +x /opt/scripts/*

  export TZ=Etc/UTC
  export DEBIAN_FRONTEND=noninteractive
  apt-get update && apt-get install -y \
    automake \
    autoconf \
    build-essential \
    cmake \
    git \
    libcurl4-openssl-dev \
    libfontconfig-dev \
    libfribidi-dev \
    libharfbuzz-dev \
    liblzma-dev \
    libncurses5-dev \
    libssl-dev \
    libxml2-dev \
    libzstd-dev \
    python3 \
    python3-cffi \
    python3-pip \
    python3-virtualenv \
    r-base \
    r-base-dev \
    tzdata \
    unzip \
    wget \
    zlib1g-dev \
    libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev \
    libmagick++-dev

  Rscript --no-save /usr/local/bin/install_packages_or_die.R remotes readr GGally
  Rscript --no-save /usr/local/bin/install_github_package_or_die.R jdstorey/qvalue qvalue

  git clone https://github.com/samtools/htslib /htslib
  cd /htslib
  git checkout 1.13
  git submodule update --init --recursive
  autoreconf -i
  ./configure
  make
  install bgzip /usr/local/bin
  install tabix /usr/local/bin

  git clone https://github.com/samtools/bcftools /bcftools
  cd /bcftools
  git checkout 1.13
  make
  make install

  mkdir /plink && cd /plink
  wget https://s3.amazonaws.com/plink2-assets/alpha4/plink2_linux_x86_64_20230813.zip
  unzip plink2_linux_x86_64_20230813.zip
  install -T plink2 /usr/local/bin/plink2

  #git clone https://github.com/broadinstitute/tensorqtl /tensorqtl-git
  #rev=3cdaa828460a9e9eee44ee98ddfbe74f2069cf5e 

  git clone https://github.com/porchard/tensorqtl /tensorqtl-git
  rev=invnorm-after-residualization

  cd /tensorqtl-git
  git checkout $rev
  python3 -m pip install -r install/requirements.txt .
  
  rm -r /plink/ /bcftools/ /htslib/
